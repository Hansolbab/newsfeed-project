<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‰´ìŠ¤í”¼ë“œ (ìš°ì„ ìˆœìœ„ &amp; ê³µê°œ ë²”ìœ„ + í˜ì´ì§€ë„¤ì´ì…˜)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 800px; margin: 0 auto; }
        h1, h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="password"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer;
            font-size: 16px; margin-right: 10px; margin-bottom: 10px;
        }
        button:hover { background-color: #0056b3; }
        .feed-list { margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;}
        .feed-item {
            border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 15px; border-radius: 6px; background-color: #f9f9f9;
        }
        .feed-item h3 { margin-top: 0; color: #007bff; font-size: 1.2em; }
        .feed-item p { margin-bottom: 5px; color: #555; }
        .feed-item img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 10px; }
        .error { color: red; font-weight: bold; margin-top: 10px; }
        .token-info { background-color: #e9ecef; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 0.9em; word-wrap: break-word;}
        .section { margin-bottom: 30px; padding: 15px; border: 1px dashed #b1b1b1; border-radius: 8px; background-color: #fafafa;}

        /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
        .pagination { display: flex; justify-content: center; margin-top: 20px; }
        .pagination button {
            background-color: #f0f0f0; color: #333; border: 1px solid #ddd; border-radius: 4px;
            padding: 8px 12px; margin: 0 4px; cursor: pointer; font-size: 0.9em;
        }
        .pagination button.active {
            background-color: #007bff; color: white; border-color: #007bff;
        }
        .pagination button:disabled {
            opacity: 0.5; cursor: not-allowed;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ë‰´ìŠ¤í”¼ë“œ ìš°ì„ ìˆœìœ„ &amp; ê³µê°œ ë²”ìœ„ í…ŒìŠ¤íŠ¸</h1>

    <div class="section">
        <h2>ë¡œê·¸ì¸</h2>
        <div>
            <input type="text" id="username" placeholder="ì´ë©”ì¼ (username)" value="aaaaaa1@example.com">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="hansol1@">
            <button onclick="login()">ë¡œê·¸ì¸</button>
            <div id="tokenDisplay" class="token-info"></div>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <div class="section">
        <h2>ê²Œì‹œê¸€ ì¡°íšŒ</h2>
        <p>
            <b>í…ŒìŠ¤íŠ¸ ë°©ë²•:</b> ê³„ì • ë³„ ë¡œê·¸ì¸ í›„ 'ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°' í´ë¦­.
            <br> í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ì´ë™í•˜ë©° í•„í„°ë§/ì •ë ¬/í‘œì‹œë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        </p>
        <button onclick="loadFeeds(0)">ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ì²« í˜ì´ì§€)</button>
        <div id="feedsContainer" class="feed-list"></div>
        <div id="feedsError" class="error"></div>
        <div id="paginationContainer" class="pagination"></div> <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì´ ë“¤ì–´ê°ˆ ê³³ -->
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8080'; // â­ ë°±ì—”ë“œ API ì£¼ì†Œ â­
    const PAGE_SIZE = 10; // í•œ í˜ì´ì§€ì— ê°€ì ¸ì˜¬ ê²Œì‹œê¸€ ìˆ˜

    let authToken = ''; // ë¡œê·¸ì¸ í›„ JWT í† í°ì´ ì—¬ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤.
    let currentPage = 0; // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ (0ë¶€í„° ì‹œì‘)

    // --- ë¡œê·¸ì¸ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼) ---
    async function login() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const tokenDisplay = document.getElementById('tokenDisplay');
        const loginError = document.getElementById('loginError');

        loginError.textContent = '';
        tokenDisplay.textContent = '';
        tokenDisplay.style.color = 'black';

        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/signIn`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: username, password: password })
            });

            if (response.ok) {
                const responseData = await response.json(); // ì‘ë‹µ bodyë¥¼ JSONìœ¼ë¡œ íŒŒì‹±
                const accessToken = responseData.accessToken; // SignInResponseDtoì˜ accessToken í•„ë“œì— ì ‘ê·¼

                if (accessToken) {
                    authToken = `Bearer ${accessToken}`;
                    tokenDisplay.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! ì•¡ì„¸ìŠ¤ í† í°: ${accessToken.substring(0, 30)}...`;
                    tokenDisplay.style.color = 'green';
                    loadFeeds(0); // ë¡œê·¸ì¸ ì„±ê³µ í›„ ìë™ìœ¼ë¡œ ì²« í˜ì´ì§€ ë¡œë“œ
                } else {
                    tokenDisplay.textContent = `ë¡œê·¸ì¸ ì„±ê³µ! í•˜ì§€ë§Œ ì‘ë‹µ ë°”ë””ì—ì„œ ì•¡ì„¸ìŠ¤ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                    console.warn('Access token missing in response body:', responseData);
                    tokenDisplay.style.color = 'orange';
                }
            } else {
                const errorData = await response.json();
                loginError.textContent = `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorData.message || response.statusText}`;
                loginError.style.color = 'red';
            }
        } catch (error) {
            loginError.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            loginError.style.color = 'red';
        }
    }

    // --- ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©) ---
    async function loadFeeds(pageNumber) {
        currentPage = pageNumber; // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸

        const feedsContainer = document.getElementById('feedsContainer');
        const feedsError = document.getElementById('feedsError');
        const paginationContainer = document.getElementById('paginationContainer');

        feedsContainer.innerHTML = ''; // ì´ì „ ê²Œì‹œê¸€ ì´ˆê¸°í™”
        feedsError.textContent = ''; // ì—ëŸ¬ ë©”ì‹œì§€ ì´ˆê¸°í™”
        paginationContainer.innerHTML = ''; // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”

        if (!authToken) {
            feedsError.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/feeds?page=${currentPage}&size=${PAGE_SIZE}`, {
                method: 'GET',
                headers: {
                    'Authorization': authToken
                }
            });

            if (response.ok) {
                const data = await response.json();
                console.log(data);
                displayFeeds(data); // ê²Œì‹œê¸€ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
                displayPagination(data.number, data.totalPages, data.first, data.last); // í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ
            } else {
                const errorData = await response.json();
                feedsError.textContent = `ê²Œì‹œê¸€ ë¡œë“œ ì‹¤íŒ¨: ${errorData.message || response.statusText}`;
                feedsError.style.color = 'red';
            }
        } catch (error) {
            feedsError.textContent = `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
            feedsError.style.color = 'red';
        }
    }

    // --- ê²Œì‹œê¸€ í‘œì‹œ í•¨ìˆ˜ ---


    function displayFeeds(data) {
        const feedsContainer = document.getElementById('feedsContainer');
        feedsContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°

        if (!data || !data.content || !Array.isArray(data.content) || data.content.length === 0) {
            feedsContainer.textContent = 'í‘œì‹œí•  ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.';
            return;
        }

        data.content.forEach(feed => {
            const feedItem = document.createElement('div');
            feedItem.className = 'feed-item';

            // í”„ë¡œí•„ ì´ë¯¸ì§€
            const profileImg = feed.userProfileImageUrl
                ? `<img src="${feed.userProfileImageUrl}" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="width:50px; height:50px; border-radius:50%;">`
                : 'ì—†ìŒ';

            // í”¼ë“œ ì´ë¯¸ì§€
            const feedImgs = (feed.feedImageUrlList && feed.feedImageUrlList.length > 0)
                ? feed.feedImageUrlList.map(url => `<img src="${url}" alt="Feed Image" style="max-width:300px; height:auto; margin-top:10px;">`).join('')
                : '';

            feedItem.innerHTML = `
                    <h3>[FeedID: ${feed.feedId}] <button class="followBtn" data-user-id="${feed.userId}">
                ${feed.followed ? "âœ… íŒ”ë¡œì‰" : "âŒ íŒ”ë¡œìš°"} </button> </h3>

                    <p><strong>ì‘ì„±ì:</strong> ${feed.userName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</p>
                    <p><strong>í”„ë¡œí•„ ì´ë¯¸ì§€:</strong> ${profileImg}</p>
                    <p><strong>ì¹´í…Œê³ ë¦¬:</strong> ${feed.category}</p>
                    <p><strong>ë‚´ìš© :</strong> ${feed.contents || ''}</p>
                    <p><strong>ì¢‹ì•„ìš” ìˆ˜:</strong> ${feed.likeTotal} / <strong>ëŒ“ê¸€ ìˆ˜:</strong> ${feed.commentTotal}</p>
                    <p><strong>ë‚˜ì˜ ì¢‹ì•„ìš” ì—¬ë¶€:</strong>  ${feed.liked ? 'ğŸ’–' : 'ğŸ¤'} </p>
                    <p><strong>ì‘ì„±ì¼:</strong> ${new Date(feed.createdAt).toLocaleString()}</p>
                    ${feedImgs}
    `;
            // íŒ”ë¡œìš° ë²„íŠ¼ ì´ë²¤íŠ¸
            const followBtn = feedItem.querySelector('.followBtn');
            followBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/follows/${feed.userId}/follow`, {
                        method: 'POST', // íŒ”ë¡œìš° APIì— ë§ê²Œ POST/PUT ë“± ì„¤ì •
                        headers: {
                            'Authorization': authToken,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json(); // ì˜ˆ: { followed: true/false }
                        // followStatusì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                        followBtn.textContent = data.followStatus === "REQUESTED"
                            ? "ğŸ’¬ ìš”ì²­ì¤‘"
                            : (data.followed ? "âœ… íŒ”ë¡œì‰" : "âŒ íŒ”ë¡œìš°");
                    } else {
                        const errorData = await response.json();
                        alert(`íŒ”ë¡œìš° ì‹¤íŒ¨: ${errorData.message || response.statusText}`);
                    }
                } catch (error) {
                    alert(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`);
                }
            });
            // ì¢‹ì•„ìš” ë²„íŠ¼
            feedsContainer.appendChild(feedItem);
        });
    }

    // --- í˜ì´ì§€ë„¤ì´ì…˜ í‘œì‹œ í•¨ìˆ˜ ---
    function displayPagination(number, totalPages, isFirst, isLast) {
        const paginationContainer = document.getElementById('paginationContainer');
        paginationContainer.innerHTML = ''; // ê¸°ì¡´ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì§€ìš°ê¸°

        // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
        const prevButton = document.createElement('button');
        prevButton.textContent = 'ì´ì „';
        prevButton.onclick = () => loadFeeds(number - 1);
        prevButton.disabled = isFirst;
        paginationContainer.appendChild(prevButton);

        // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ë“¤
        for (let i = 0; i < totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.textContent = i + 1; // í˜ì´ì§€ ë²ˆí˜¸ëŠ” 1ë¶€í„° ì‹œì‘
            pageButton.onclick = () => loadFeeds(i);
            if (i === number) { // í˜„ì¬ í˜ì´ì§€
                pageButton.classList.add('active');
                pageButton.disabled = true; // í˜„ì¬ í˜ì´ì§€ëŠ” ë¹„í™œì„±í™”
            }
            paginationContainer.appendChild(pageButton);
        }

        // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
        const nextButton = document.createElement('button');
        nextButton.textContent = 'ë‹¤ìŒ';
        nextButton.onclick = () => loadFeeds(number + 1);
        nextButton.disabled = isLast;
        paginationContainer.appendChild(nextButton);
    }
</script>
</body>
</html>